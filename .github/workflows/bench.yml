# Benchmark workflow - fair comparisons across plain-text accounting tools
#
# Two benchmark groups (all 4 tools in each):
# 1. Validation: Parse + check/validate
# 2. Balance report: Parse + compute balances
#
# Note: rustledger & beancount use .beancount format; ledger & hledger use .ledger format
#
name: Benchmarks
on:
  schedule:
    - cron: '0 2 * * *'  # Nightly at 2 AM UTC
  release:
    types: [published]
  workflow_dispatch:

# Prevent concurrent benchmark runs from racing on the benchmarks branch
concurrency:
  group: benchmarks
  cancel-in-progress: false

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark-comparison:
    name: Run benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          prefix-key: bench

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          # Python beancount + beanquery (for BQL)
          pip install beancount beanquery matplotlib

          # Build dependencies for ledger (C++)
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libboost-system-dev libboost-dev \
            libboost-date-time-dev libboost-filesystem-dev libboost-iostreams-dev \
            libboost-regex-dev libboost-test-dev libedit-dev libgmp3-dev libmpfr-dev

          # hledger (Haskell) - pre-built binary from GitHub
          curl -sL https://github.com/simonmichael/hledger/releases/latest/download/hledger-linux-x64.tar.gz | tar xz -C /tmp
          sudo mv /tmp/hledger /usr/local/bin/

          # Hyperfine for accurate benchmarking (use latest release)
          HYPERFINE_VERSION=$(curl -s https://api.github.com/repos/sharkdp/hyperfine/releases/latest | jq -r '.tag_name')
          curl -sL "https://github.com/sharkdp/hyperfine/releases/download/${HYPERFINE_VERSION}/hyperfine-${HYPERFINE_VERSION}-x86_64-unknown-linux-gnu.tar.gz" | tar xz -C /tmp
          sudo mv "/tmp/hyperfine-${HYPERFINE_VERSION}-x86_64-unknown-linux-gnu/hyperfine" /usr/local/bin/

      - name: Build ledger from source
        run: |
          # Get latest release tag from GitHub API
          LEDGER_VERSION=$(curl -s https://api.github.com/repos/ledger/ledger/releases/latest | jq -r '.tag_name')
          echo "Building ledger ${LEDGER_VERSION}"

          cd /tmp
          curl -sL "https://github.com/ledger/ledger/archive/refs/tags/${LEDGER_VERSION}.tar.gz" | tar xz
          cd "ledger-${LEDGER_VERSION#v}"
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_DOCS=OFF -DBUILD_WEB_DOCS=OFF
          cmake --build build --parallel $(nproc)
          sudo cp build/ledger /usr/local/bin/

      - name: Verify tool installations
        run: |
          echo "=== Installed versions ==="
          ledger --version | head -1
          hledger --version
          hyperfine --version
          bean-check --version
          bean-query --version

      - name: Build rustledger
        run: |
          cargo build --release -p rustledger --no-default-features

      - name: Generate test ledgers
        run: |
          python3 << 'EOF'
          import random
          from datetime import date, timedelta

          random.seed(42)  # Reproducible

          # Beancount accounts (need open directives)
          bean_accounts = [
              "Assets:Bank:Checking",
              "Assets:Bank:Savings",
              "Assets:Investments:Stocks",
              "Liabilities:CreditCard",
              "Expenses:Food:Groceries",
              "Expenses:Food:Restaurant",
              "Expenses:Transport:Gas",
              "Expenses:Transport:PublicTransit",
              "Expenses:Utilities:Electric",
              "Expenses:Utilities:Internet",
              "Expenses:Shopping:Clothing",
              "Expenses:Shopping:Electronics",
              "Income:Salary",
              "Income:Interest",
              "Equity:Opening-Balances",
          ]

          # Generate transactions
          transactions = []
          start_date = date(2020, 1, 1)
          for i in range(10000):
              d = start_date + timedelta(days=i // 10)
              amount = round(random.uniform(5, 500), 2)
              expense = random.choice([a for a in bean_accounts if a.startswith("Expenses:")])
              source = random.choice(["Assets:Bank:Checking", "Liabilities:CreditCard"])
              payee = f"Payee {i % 100}"
              narration = f"Transaction {i}"
              transactions.append((d, payee, narration, expense, source, amount))

          # Write Beancount format
          with open("benchmark.beancount", "w") as f:
              f.write('option "operating_currency" "USD"\n\n')
              for acc in bean_accounts:
                  f.write(f"2020-01-01 open {acc}\n")
              f.write("\n")
              for d, payee, narration, expense, source, amount in transactions:
                  f.write(f'{d} * "{payee}" "{narration}"\n')
                  f.write(f"  {expense}  {amount} USD\n")
                  f.write(f"  {source}\n\n")

          # Write Ledger/hledger format (they share the same format)
          with open("benchmark.ledger", "w") as f:
              for d, payee, narration, expense, source, amount in transactions:
                  f.write(f"{d} {payee} | {narration}\n")
                  f.write(f"    {expense}  ${amount:.2f}\n")
                  f.write(f"    {source}\n\n")

          print("Generated benchmark.beancount and benchmark.ledger (10K transactions each)")
          EOF

      - name: Run validation benchmarks
        id: bench_validation
        run: |
          echo "=== Validation Benchmark (parse + check) ==="
          hyperfine \
            --warmup 3 \
            --runs 10 \
            --export-json bench-validation.json \
            --command-name 'rustledger' './target/release/rledger-check benchmark.beancount' \
            --command-name 'beancount' 'bean-check benchmark.beancount' \
            --command-name 'ledger' 'ledger -f benchmark.ledger accounts' \
            --command-name 'hledger' 'hledger check -f benchmark.ledger'

          # Extract results
          python3 << 'EOF'
          import json
          import os

          with open('bench-validation.json') as f:
              results = json.load(f)

          times = {}
          for r in results['results']:
              name = r['command']
              mean_ms = r['mean'] * 1000
              times[name] = round(mean_ms, 1)

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"rustledger_val_ms={times.get('rustledger', 0)}\n")
              f.write(f"beancount_val_ms={times.get('beancount', 0)}\n")
              f.write(f"ledger_val_ms={times.get('ledger', 0)}\n")
              f.write(f"hledger_val_ms={times.get('hledger', 0)}\n")

          print(f"rustledger: {times.get('rustledger')}ms")
          print(f"beancount:  {times.get('beancount')}ms")
          print(f"ledger:     {times.get('ledger')}ms")
          print(f"hledger:    {times.get('hledger')}ms")
          EOF

      - name: Run balance benchmarks
        id: bench_balance
        run: |
          echo "=== Balance Report Benchmark (parse + compute) ==="
          hyperfine \
            --warmup 3 \
            --runs 10 \
            --export-json bench-balance.json \
            --command-name 'rustledger' './target/release/rledger-report benchmark.beancount balances > /dev/null' \
            --command-name 'beancount' 'bean-query -q benchmark.beancount BALANCES > /dev/null' \
            --command-name 'ledger' 'ledger -f benchmark.ledger balance > /dev/null' \
            --command-name 'hledger' 'hledger -f benchmark.ledger balance > /dev/null'

          # Extract results
          python3 << 'EOF'
          import json
          import os

          with open('bench-balance.json') as f:
              results = json.load(f)

          times = {}
          for r in results['results']:
              name = r['command']
              mean_ms = r['mean'] * 1000
              times[name] = round(mean_ms, 1)

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"rustledger_bal_ms={times.get('rustledger', 0)}\n")
              f.write(f"beancount_bal_ms={times.get('beancount', 0)}\n")
              f.write(f"ledger_bal_ms={times.get('ledger', 0)}\n")
              f.write(f"hledger_bal_ms={times.get('hledger', 0)}\n")

          print(f"rustledger: {times.get('rustledger')}ms")
          print(f"beancount:  {times.get('beancount')}ms")
          print(f"ledger:     {times.get('ledger')}ms")
          print(f"hledger:    {times.get('hledger')}ms")
          EOF

      - name: Fetch existing history from benchmarks branch
        run: |
          mkdir -p .github/badges
          curl -sSf https://raw.githubusercontent.com/${{ github.repository }}/benchmarks/.github/badges/validation-history.json \
            -o .github/badges/validation-history.json 2>/dev/null || echo "[]" > .github/badges/validation-history.json
          curl -sSf https://raw.githubusercontent.com/${{ github.repository }}/benchmarks/.github/badges/balance-history.json \
            -o .github/badges/balance-history.json 2>/dev/null || echo "[]" > .github/badges/balance-history.json

      - name: Update results and generate charts
        run: |
          python3 << 'EOF'
          import json
          import os
          from datetime import datetime
          import matplotlib.pyplot as plt
          import matplotlib.dates as mdates
          from pathlib import Path

          # Get validation results
          rustledger_val = float(os.environ.get('RUSTLEDGER_VAL_MS', 0))
          beancount_val = float(os.environ.get('BEANCOUNT_VAL_MS', 0))
          ledger_val = float(os.environ.get('LEDGER_VAL_MS', 0))
          hledger_val = float(os.environ.get('HLEDGER_VAL_MS', 0))

          # Get balance results
          rustledger_bal = float(os.environ.get('RUSTLEDGER_BAL_MS', 0))
          beancount_bal = float(os.environ.get('BEANCOUNT_BAL_MS', 0))
          ledger_bal = float(os.environ.get('LEDGER_BAL_MS', 0))
          hledger_bal = float(os.environ.get('HLEDGER_BAL_MS', 0))

          now = datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ')
          date_short = datetime.utcnow().strftime('%Y-%m-%d')

          # Update validation history
          val_history_file = Path('.github/badges/validation-history.json')
          val_history = json.loads(val_history_file.read_text())
          val_history.append({
              'date': date_short,
              'timestamp': now,
              'rustledger_ms': rustledger_val,
              'beancount_ms': beancount_val,
              'ledger_ms': ledger_val,
              'hledger_ms': hledger_val,
          })
          val_history = val_history[-90:]
          val_history_file.write_text(json.dumps(val_history, indent=2))

          # Update balance history
          bal_history_file = Path('.github/badges/balance-history.json')
          bal_history = json.loads(bal_history_file.read_text())
          bal_history.append({
              'date': date_short,
              'timestamp': now,
              'rustledger_ms': rustledger_bal,
              'beancount_ms': beancount_bal,
              'ledger_ms': ledger_bal,
              'hledger_ms': hledger_bal,
          })
          bal_history = bal_history[-90:]
          bal_history_file.write_text(json.dumps(bal_history, indent=2))

          # Common chart styling
          plt.style.use('dark_background')

          def style_chart(ax, fig):
              ax.grid(True, alpha=0.3, linestyle='--')
              ax.set_facecolor('#1a1a2e')
              fig.patch.set_facecolor('#1a1a2e')
              ax.xaxis.set_major_formatter(mdates.DateFormatter('%b %d'))
              ax.xaxis.set_major_locator(mdates.AutoDateLocator())
              plt.xticks(rotation=45, ha='right')

          # Generate validation chart (all 4 tools)
          if len(val_history) >= 2:
              dates = [datetime.strptime(h['date'], '%Y-%m-%d') for h in val_history]
              rustledger_times = [h.get('rustledger_ms', 0) for h in val_history]
              beancount_times = [h.get('beancount_ms', 0) for h in val_history]
              ledger_times = [h.get('ledger_ms', 0) for h in val_history]
              hledger_times = [h.get('hledger_ms', 0) for h in val_history]

              fig, ax = plt.subplots(figsize=(10, 4), dpi=100)
              ax.plot(dates, beancount_times, 'o-', color='#f4b942', linewidth=2,
                      markersize=5, label='beancount (Python)')
              ax.plot(dates, hledger_times, 's-', color='#e74c3c', linewidth=2,
                      markersize=5, label='hledger (Haskell)')
              ax.plot(dates, ledger_times, '^-', color='#9b59b6', linewidth=2,
                      markersize=5, label='ledger (C++)')
              ax.plot(dates, rustledger_times, 'o-', color='#00d4aa', linewidth=2,
                      markersize=5, label='rustledger')

              ax.set_ylabel('Time (ms)', fontsize=12, color='white')
              ax.legend(loc='upper right', framealpha=0.9)
              ax.set_title('Validation: Parse + Check (10K transactions)', fontsize=13, color='white', pad=10)
              style_chart(ax, fig)

              plt.tight_layout()
              plt.savefig('.github/badges/validation-chart.svg', format='svg',
                          facecolor='#1a1a2e', edgecolor='none', bbox_inches='tight')
              plt.savefig('.github/badges/validation-chart.png', format='png',
                          facecolor='#1a1a2e', edgecolor='none', bbox_inches='tight')
              plt.close()
              print(f"Generated validation chart with {len(val_history)} data points")

          # Generate balance chart (all 4 tools)
          if len(bal_history) >= 2:
              dates = [datetime.strptime(h['date'], '%Y-%m-%d') for h in bal_history]
              rustledger_times = [h.get('rustledger_ms', 0) for h in bal_history]
              beancount_times = [h.get('beancount_ms', 0) for h in bal_history]
              ledger_times = [h.get('ledger_ms', 0) for h in bal_history]
              hledger_times = [h.get('hledger_ms', 0) for h in bal_history]

              fig, ax = plt.subplots(figsize=(10, 4), dpi=100)
              ax.plot(dates, beancount_times, 'o-', color='#f4b942', linewidth=2,
                      markersize=5, label='beancount (Python)')
              ax.plot(dates, hledger_times, 's-', color='#e74c3c', linewidth=2,
                      markersize=5, label='hledger (Haskell)')
              ax.plot(dates, ledger_times, '^-', color='#9b59b6', linewidth=2,
                      markersize=5, label='ledger (C++)')
              ax.plot(dates, rustledger_times, 'o-', color='#00d4aa', linewidth=2,
                      markersize=5, label='rustledger')

              ax.set_ylabel('Time (ms)', fontsize=12, color='white')
              ax.legend(loc='upper right', framealpha=0.9)
              ax.set_title('Balance Report: Parse + Compute (10K transactions)', fontsize=13, color='white', pad=10)
              style_chart(ax, fig)

              plt.tight_layout()
              plt.savefig('.github/badges/balance-chart.svg', format='svg',
                          facecolor='#1a1a2e', edgecolor='none', bbox_inches='tight')
              plt.savefig('.github/badges/balance-chart.png', format='png',
                          facecolor='#1a1a2e', edgecolor='none', bbox_inches='tight')
              plt.close()
              print(f"Generated balance chart with {len(bal_history)} data points")

          # Summary
          print(f"\n## Benchmark Results (10K transactions)")
          print(f"\nValidation (parse + check):")
          print(f"  rustledger: {rustledger_val}ms")
          print(f"  ledger:     {ledger_val}ms")
          print(f"  hledger:    {hledger_val}ms")
          print(f"  beancount:  {beancount_val}ms")
          print(f"\nBalance report (parse + compute):")
          print(f"  ledger:     {ledger_bal}ms")
          print(f"  rustledger: {rustledger_bal}ms")
          print(f"  hledger:    {hledger_bal}ms")
          print(f"  beancount:  {beancount_bal}ms")
          EOF
        env:
          RUSTLEDGER_VAL_MS: ${{ steps.bench_validation.outputs.rustledger_val_ms }}
          BEANCOUNT_VAL_MS: ${{ steps.bench_validation.outputs.beancount_val_ms }}
          LEDGER_VAL_MS: ${{ steps.bench_validation.outputs.ledger_val_ms }}
          HLEDGER_VAL_MS: ${{ steps.bench_validation.outputs.hledger_val_ms }}
          RUSTLEDGER_BAL_MS: ${{ steps.bench_balance.outputs.rustledger_bal_ms }}
          BEANCOUNT_BAL_MS: ${{ steps.bench_balance.outputs.beancount_bal_ms }}
          LEDGER_BAL_MS: ${{ steps.bench_balance.outputs.ledger_bal_ms }}
          HLEDGER_BAL_MS: ${{ steps.bench_balance.outputs.hledger_bal_ms }}

      - name: Update summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Benchmark Results (10K transactions)

          ### Validation (parse + check)
          | Tool | Time |
          |------|------|
          | **rustledger** | ${{ steps.bench_validation.outputs.rustledger_val_ms }}ms |
          | ledger (C++) | ${{ steps.bench_validation.outputs.ledger_val_ms }}ms |
          | hledger (Haskell) | ${{ steps.bench_validation.outputs.hledger_val_ms }}ms |
          | beancount (Python) | ${{ steps.bench_validation.outputs.beancount_val_ms }}ms |

          ### Balance Report (parse + compute)
          | Tool | Time |
          |------|------|
          | ledger (C++) | ${{ steps.bench_balance.outputs.ledger_bal_ms }}ms |
          | **rustledger** | ${{ steps.bench_balance.outputs.rustledger_bal_ms }}ms |
          | hledger (Haskell) | ${{ steps.bench_balance.outputs.hledger_bal_ms }}ms |
          | beancount (Python) | ${{ steps.bench_balance.outputs.beancount_bal_ms }}ms |

          *Measured with [hyperfine](https://github.com/sharkdp/hyperfine) (10 runs, 3 warmup)*

          Note: rustledger & beancount use .beancount format; ledger & hledger use .ledger format
          EOF

      - name: Commit results to benchmarks branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Save the generated files
          cp -r .github/badges /tmp/badges

          # Discard local changes and untracked files before switching branches
          git checkout -- .
          git clean -fd

          # Fetch and checkout benchmarks branch (create if doesn't exist)
          git fetch origin benchmarks || true
          if git rev-parse --verify origin/benchmarks >/dev/null 2>&1; then
            git checkout benchmarks
            # Pull any changes to avoid race conditions
            git pull --rebase origin benchmarks || true
          else
            git checkout --orphan benchmarks
            git rm -rf . || true
            mkdir -p .github/badges
          fi

          # Copy results and commit
          cp -r /tmp/badges/* .github/badges/
          git add .github/badges/
          git diff --staged --quiet || git commit -m "chore: update benchmark results"
          git push origin benchmarks
