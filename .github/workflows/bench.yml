# Benchmark workflow - compares rustledger vs Python beancount
name: Benchmarks
on:
  schedule:
    - cron: '0 2 * * *'  # Nightly at 2 AM UTC
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark-comparison:
    name: Compare rustledger vs Python beancount
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          prefix-key: bench

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install beancount matplotlib

      - name: Build rustledger (without WASM for faster build)
        run: |
          # Build without wasm-runtime feature - not needed for benchmarking
          cargo build --release -p rustledger --no-default-features

      - name: Generate test ledger
        run: |
          python3 << 'EOF'
          import random
          from datetime import date, timedelta

          random.seed(42)  # Reproducible

          accounts = [
              "Assets:Bank:Checking",
              "Assets:Bank:Savings",
              "Assets:Investments:Stocks",
              "Liabilities:CreditCard",
              "Expenses:Food:Groceries",
              "Expenses:Food:Restaurant",
              "Expenses:Transport:Gas",
              "Expenses:Transport:PublicTransit",
              "Expenses:Utilities:Electric",
              "Expenses:Utilities:Internet",
              "Expenses:Shopping:Clothing",
              "Expenses:Shopping:Electronics",
              "Income:Salary",
              "Income:Interest",
              "Equity:Opening-Balances",
          ]

          with open("benchmark.beancount", "w") as f:
              f.write('option "operating_currency" "USD"\n\n')
              for acc in accounts:
                  f.write(f"2020-01-01 open {acc}\n")
              f.write("\n")

              start_date = date(2020, 1, 1)
              for i in range(10000):
                  d = start_date + timedelta(days=i // 10)
                  amount = round(random.uniform(5, 500), 2)
                  expense = random.choice([a for a in accounts if a.startswith("Expenses:")])
                  source = random.choice(["Assets:Bank:Checking", "Liabilities:CreditCard"])
                  f.write(f'{d} * "Payee {i % 100}" "Transaction {i}"\n')
                  f.write(f"  {expense}  {amount} USD\n")
                  f.write(f"  {source}\n\n")
          EOF

      - name: Benchmark Python beancount
        id: python_bench
        run: |
          bean-check benchmark.beancount > /dev/null 2>&1  # warm up
          total=0
          for i in {1..5}; do
            start=$(date +%s%N)
            bean-check benchmark.beancount > /dev/null 2>&1
            end=$(date +%s%N)
            elapsed=$(( (end - start) / 1000000 ))
            total=$((total + elapsed))
          done
          avg=$((total / 5))
          echo "python_ms=$avg" >> $GITHUB_OUTPUT
          echo "Python beancount: ${avg}ms"

      - name: Benchmark rustledger
        id: rust_bench
        run: |
          ./target/release/rledger-check benchmark.beancount > /dev/null 2>&1  # warm up
          total=0
          for i in {1..5}; do
            start=$(date +%s%N)
            ./target/release/rledger-check benchmark.beancount > /dev/null 2>&1
            end=$(date +%s%N)
            elapsed=$(( (end - start) / 1000000 ))
            total=$((total + elapsed))
          done
          avg=$((total / 5))
          echo "rust_ms=$avg" >> $GITHUB_OUTPUT
          echo "rustledger: ${avg}ms"

      - name: Update results and generate chart
        run: |
          python3 << 'EOF'
          import json
          import os
          from datetime import datetime
          import matplotlib.pyplot as plt
          import matplotlib.dates as mdates
          from pathlib import Path

          # Get new results
          python_ms = int(os.environ.get('PYTHON_MS', 0))
          rust_ms = int(os.environ.get('RUST_MS', 0))
          speedup = round(python_ms / rust_ms, 1) if rust_ms > 0 else 0
          now = datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ')
          date_short = datetime.utcnow().strftime('%Y-%m-%d')

          # Load existing history
          history_file = Path('.github/badges/benchmark-history.json')
          history_file.parent.mkdir(parents=True, exist_ok=True)

          if history_file.exists():
              history = json.loads(history_file.read_text())
          else:
              history = []

          # Append new result (keep last 90 days)
          history.append({
              'date': date_short,
              'timestamp': now,
              'python_ms': python_ms,
              'rust_ms': rust_ms,
              'speedup': speedup
          })
          history = history[-90:]  # Keep 90 days max

          # Save history
          history_file.write_text(json.dumps(history, indent=2))

          # Save current badge JSON (shields.io endpoint format - only allowed properties)
          badge = {
              'schemaVersion': 1,
              'label': 'speedup',
              'message': f'{speedup}x faster',
              'color': 'brightgreen' if speedup >= 5 else 'green' if speedup >= 2 else 'yellow'
          }
          Path('.github/badges/benchmark.json').write_text(json.dumps(badge, indent=2))

          # Generate chart
          if len(history) >= 2:
              dates = [datetime.strptime(h['date'], '%Y-%m-%d') for h in history]
              python_times = [h['python_ms'] for h in history]
              rust_times = [h['rust_ms'] for h in history]

              plt.style.use('dark_background')
              fig, ax = plt.subplots(figsize=(10, 4), dpi=100)

              # Plot lines
              ax.plot(dates, python_times, 'o-', color='#f4b942', linewidth=2,
                      markersize=6, label='Python beancount')
              ax.plot(dates, rust_times, 'o-', color='#00d4aa', linewidth=2,
                      markersize=6, label='rustledger')

              # Fill between
              ax.fill_between(dates, rust_times, python_times, alpha=0.2, color='#00d4aa')

              # Styling
              ax.set_ylabel('Time (ms)', fontsize=12, color='white')
              ax.set_xlabel('')
              ax.legend(loc='upper right', framealpha=0.9)
              ax.set_title('Validation Time: 10K Transactions', fontsize=14, color='white', pad=10)

              # Format x-axis
              ax.xaxis.set_major_formatter(mdates.DateFormatter('%b %d'))
              ax.xaxis.set_major_locator(mdates.AutoDateLocator())
              plt.xticks(rotation=45, ha='right')

              # Grid
              ax.grid(True, alpha=0.3, linestyle='--')
              ax.set_facecolor('#1a1a2e')
              fig.patch.set_facecolor('#1a1a2e')

              # Add speedup annotation
              latest_speedup = history[-1]['speedup']
              ax.annotate(f'{latest_speedup}x faster',
                          xy=(dates[-1], (python_times[-1] + rust_times[-1]) / 2),
                          xytext=(10, 0), textcoords='offset points',
                          fontsize=11, color='#00d4aa', fontweight='bold',
                          va='center')

              plt.tight_layout()
              plt.savefig('.github/badges/benchmark-chart.svg', format='svg',
                          facecolor='#1a1a2e', edgecolor='none', bbox_inches='tight')
              plt.savefig('.github/badges/benchmark-chart.png', format='png',
                          facecolor='#1a1a2e', edgecolor='none', bbox_inches='tight')
              plt.close()
              print(f"Generated chart with {len(history)} data points")
          else:
              print("Not enough data points for chart yet")

          # Summary
          print(f"\n## Benchmark Results")
          print(f"Python beancount: {python_ms}ms")
          print(f"rustledger: {rust_ms}ms")
          print(f"Speedup: {speedup}x faster")
          EOF
        env:
          PYTHON_MS: ${{ steps.python_bench.outputs.python_ms }}
          RUST_MS: ${{ steps.rust_bench.outputs.rust_ms }}

      - name: Update summary
        run: |
          python_ms=${{ steps.python_bench.outputs.python_ms }}
          rust_ms=${{ steps.rust_bench.outputs.rust_ms }}
          speedup=$(echo "scale=1; $python_ms / $rust_ms" | bc)
          echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Time |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python beancount | ${python_ms}ms |" >> $GITHUB_STEP_SUMMARY
          echo "| rustledger | ${rust_ms}ms |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Speedup: ${speedup}x faster**" >> $GITHUB_STEP_SUMMARY

      - name: Commit results to benchmarks branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Save the generated files
          cp -r .github/badges /tmp/badges

          # Discard local changes before switching branches
          git checkout -- .

          # Fetch and checkout benchmarks branch (create if doesn't exist)
          git fetch origin benchmarks || true
          if git rev-parse --verify origin/benchmarks >/dev/null 2>&1; then
            git checkout benchmarks
          else
            git checkout --orphan benchmarks
            git rm -rf . || true
            mkdir -p .github/badges
          fi

          # Copy results and commit
          cp -r /tmp/badges/* .github/badges/
          git add .github/badges/
          git diff --staged --quiet || git commit -m "chore: update benchmark results"
          git push origin benchmarks
