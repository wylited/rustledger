# Release Workflow
# ================
# Triggered on version tags (v*). Builds and publishes to all distribution channels.
#
# RELEASE STRATEGY
# ----------------
# Prereleases (e.g., v1.0.0-rc.19):
#   - GitHub Releases: ✓
#   - crates.io: ✓
#   - npm: ✓ (tagged as "next", not "latest")
#   - Docker: ✓ (version tag only, no "latest")
#   - Homebrew tap: ✓ (rustledger/homebrew-rustledger)
#   - Scoop bucket: ✓ (rustledger/scoop-rustledger)
#   - AUR: ✓ (user repository)
#   - nixpkgs: ✗ (skipped)
#
# Stable releases (e.g., v1.0.0):
#   - All of the above, plus:
#   - npm: tagged as "latest"
#   - Docker: tagged as "latest"
#   - nixpkgs: PR created automatically
#
# DISTRIBUTION CHANNELS
# ---------------------
# | Channel      | Repo/Registry                          | Auto-update |
# |--------------|----------------------------------------|-------------|
# | Binaries     | GitHub Releases                        | ✓           |
# | Cargo        | crates.io                              | ✓           |
# | npm (wasm)   | @rustledger/wasm                       | ✓           |
# | npm (mcp)    | @rustledger/mcp-server                 | ✓           |
# | Docker       | ghcr.io/rustledger/rustledger          | ✓           |
# | Homebrew     | rustledger/homebrew-rustledger         | ✓           |
# | Scoop        | rustledger/scoop-rustledger            | ✓           |
# | AUR          | aur.archlinux.org/rustledger{,-bin}    | ✓           |
# | nixpkgs      | NixOS/nixpkgs (PR)                     | ✓ (stable)  |
# | COPR         | copr.fedorainfracloud.org/rustledger   | ✓           |
# | PPA          | ppa:rustledger/rustledger              | ✓           |
#
# SECRETS REQUIRED
# ----------------
# - CARGO_REGISTRY_TOKEN: crates.io publish
# - WEBSITE_DISPATCH_TOKEN: Homebrew/Scoop/nixpkgs automation
# - AUR_SSH_PRIVATE_KEY: AUR push access
# - COPR_API_TOKEN: COPR build trigger (from copr.fedorainfracloud.org/api)
# - LAUNCHPAD_SSH_PRIVATE_KEY: Launchpad upload access
# - LAUNCHPAD_GPG_PRIVATE_KEY: PPA package signing
# - (npm uses OIDC trusted publishing, no token needed)
#
name: Release
on:
  push:
    tags:
      - 'v*'
permissions:
  contents: write
  id-token: write # Required for npm trusted publishing (OIDC)
  packages: write # Required for GitHub Container Registry
env:
  CARGO_TERM_COLOR: always
jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux (glibc)
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true
          # Linux (musl - static binaries)
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            cross: true
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            cross: true
          # macOS
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest
          # Windows
          - target: x86_64-pc-windows-msvc
            os: windows-latest
          - target: aarch64-pc-windows-msvc
            os: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Install cross
        if: matrix.cross
        uses: taiki-e/install-action@cross
      - name: Build
        shell: bash
        run: |
          # Use classic linker on macOS - Xcode 15's new linker crashes on long symbol names
          # See: https://developer.apple.com/forums/thread/737707
          if [ "${{ runner.os }}" = "macOS" ]; then
            export RUSTFLAGS="-C link-arg=-Wl,-ld_classic"
          fi

          if [ "${{ matrix.cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
      - name: Package (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd target/${{ matrix.target }}/release

          # Get version from tag
          VERSION=${GITHUB_REF#refs/tags/}

          # Create archive with all binaries
          ARCHIVE="rustledger-${VERSION}-${{ matrix.target }}.tar.gz"
          tar -czvf "../../../${ARCHIVE}" \
            rledger-check rledger-format rledger-query rledger-report rledger-doctor rledger-extract rledger-price \
            bean-check bean-format bean-query bean-report bean-doctor bean-extract bean-price

          # Create checksum
          cd ../../..
          shasum -a 256 "$ARCHIVE" > "${ARCHIVE}.sha256"
      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd target/${{ matrix.target }}/release

          # Get version from tag
          $VERSION = $env:GITHUB_REF -replace 'refs/tags/', ''

          # Create archive with all binaries
          $ARCHIVE = "rustledger-${VERSION}-${{ matrix.target }}.zip"
          $binaries = @(
            "rledger-check.exe", "rledger-format.exe", "rledger-query.exe", "rledger-report.exe", "rledger-doctor.exe", "rledger-extract.exe", "rledger-price.exe",
            "bean-check.exe", "bean-format.exe", "bean-query.exe", "bean-report.exe", "bean-doctor.exe", "bean-extract.exe", "bean-price.exe"
          )
          Compress-Archive -Path $binaries -DestinationPath "../../../${ARCHIVE}"

          # Create checksum
          cd ../../..
          (Get-FileHash -Algorithm SHA256 $ARCHIVE).Hash.ToLower() + "  " + $ARCHIVE | Out-File -Encoding utf8 "${ARCHIVE}.sha256"
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rustledger-${{ matrix.target }}
          path: |
            rustledger-*.tar.gz
            rustledger-*.zip
            rustledger-*.sha256
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      - name: List artifacts
        run: ls -la artifacts/
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          generate_release_notes: true
          files: |
            artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # Update Homebrew tap
  update-homebrew:
    name: Update Homebrew formula
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Homebrew tap update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
          repository: rustledger/homebrew-rustledger
          event-type: release
          client-payload: '{"version": "${{ github.ref_name }}"}'

  # Update Scoop bucket
  update-scoop:
    name: Update Scoop bucket
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Scoop bucket update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
          repository: rustledger/scoop-rustledger
          event-type: release
          client-payload: '{"version": "${{ github.ref_name }}"}'
  # Publish to crates.io
  publish:
    name: Publish to crates.io
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Publish crates (in dependency order)
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          # Publish in dependency order with delay between each
          # to allow crates.io to index the previous crate
          # Use || true to continue if crate already exists

          echo "Publishing rustledger-core..."
          cargo publish -p rustledger-core --no-verify || true
          sleep 30

          echo "Publishing rustledger-parser..."
          cargo publish -p rustledger-parser --no-verify || true
          sleep 30

          echo "Publishing rustledger-booking..."
          cargo publish -p rustledger-booking --no-verify || true
          sleep 30

          echo "Publishing rustledger-loader..."
          cargo publish -p rustledger-loader --no-verify || true
          sleep 30

          echo "Publishing rustledger-validate..."
          cargo publish -p rustledger-validate --no-verify || true
          sleep 30

          echo "Publishing rustledger-query..."
          cargo publish -p rustledger-query --no-verify || true
          sleep 30

          echo "Publishing rustledger-plugin..."
          cargo publish -p rustledger-plugin --no-verify || true
          sleep 30

          echo "Publishing rustledger-importer..."
          cargo publish -p rustledger-importer --no-verify || true
          sleep 30

          echo "Publishing rustledger (CLI)..."
          cargo publish -p rustledger --no-verify || true

          echo "All crates published!"
  # Build WASM package (shared by upload-wasm and publish-wasm)
  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      - name: Build WASM package
        run: |
          cd crates/rustledger-wasm
          wasm-pack build --target web --release
      - name: Prepare package
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          cd crates/rustledger-wasm/pkg
          sed -i "s/\"version\": \".*\"/\"version\": \"${VERSION}\"/" package.json
          sed -i 's/"name": "rustledger-wasm"/"name": "@rustledger\/wasm"/' package.json
      - name: Upload WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasm-package
          path: crates/rustledger-wasm/pkg/

  # Upload WASM to GitHub release
  upload-wasm:
    name: Upload WASM to Release
    needs: build-wasm
    runs-on: ubuntu-latest
    steps:
      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: wasm-package
          path: pkg
      - name: Package WASM
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          cd pkg
          tar -czvf "../rustledger-wasm-${VERSION}.tar.gz" .
          cd ..
          shasum -a 256 "rustledger-wasm-${VERSION}.tar.gz" > "rustledger-wasm-${VERSION}.tar.gz.sha256"
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            rustledger-wasm-*.tar.gz
            rustledger-wasm-*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # Publish WASM package to npm
  publish-wasm:
    name: Publish to npm
    needs: [release, build-wasm]
    runs-on: ubuntu-latest
    steps:
      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: wasm-package
          path: pkg
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
      - name: Update npm for OIDC support
        run: npm install -g npm@latest
      - name: Publish to npm (trusted publishing)
        run: |
          cd pkg
          VERSION=${GITHUB_REF#refs/tags/v}
          # Use --tag next for prereleases, --tag latest for stable
          # Use || true to continue if version already exists
          if [[ "$VERSION" == *"-"* ]]; then
            npm publish --access public --provenance --tag next || true
          else
            npm publish --access public --provenance || true
          fi
  # Trigger website rebuild to use new WASM package
  trigger-website:
    name: Trigger website rebuild
    needs: publish-wasm
    runs-on: ubuntu-latest
    steps:
      - name: Trigger website rebuild
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
          repository: rustledger/rustledger.github.io
          event-type: wasm-release

  # Build and push Docker images
  docker:
    name: Build Docker images
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download musl artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: rustledger-*-linux-musl
          merge-multiple: true
      - name: Extract binaries
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          mkdir -p docker-context/amd64 docker-context/arm64
          tar -xzf "artifacts/rustledger-${VERSION}-x86_64-unknown-linux-musl.tar.gz" -C docker-context/amd64
          tar -xzf "artifacts/rustledger-${VERSION}-aarch64-unknown-linux-musl.tar.gz" -C docker-context/arm64
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Generate Dockerfile
        run: |
          cat > docker-context/Dockerfile << 'EOF'
          FROM scratch
          ARG TARGETARCH
          COPY ${TARGETARCH}/* /usr/local/bin/
          ENTRYPOINT ["rledger-check"]
          EOF
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/rustledger/rustledger
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable=${{ !contains(github.ref_name, '-') }}
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: docker-context
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Publish MCP server to npm
  publish-mcp:
    name: Publish MCP server to npm
    needs: publish-wasm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
      - name: Update npm for OIDC support
        run: npm install -g npm@latest
      - name: Wait for npm registry propagation
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Waiting for @rustledger/wasm@$VERSION to be available on npm..."
          for i in {1..12}; do
            if npm view @rustledger/wasm@$VERSION version 2>/dev/null; then
              echo "Package available!"
              exit 0
            fi
            echo "Attempt $i: Package not yet available, waiting 30s..."
            sleep 30
          done
          echo "Package not available after 6 minutes"
          exit 1
      - name: Update version and install dependencies
        run: |
          cd packages/mcp-server
          VERSION=${GITHUB_REF#refs/tags/v}
          # Update version in package.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json
          # Update @rustledger/wasm dependency to use npm package
          sed -i 's|"@rustledger/wasm": "file:../../crates/rustledger-wasm/pkg"|"@rustledger/wasm": "^'$VERSION'"|' package.json
          npm install
      - name: Build
        run: |
          cd packages/mcp-server
          npm run build
      - name: Publish to npm (trusted publishing)
        run: |
          cd packages/mcp-server
          VERSION=${GITHUB_REF#refs/tags/v}
          # Use --tag next for prereleases, --tag latest for stable
          # Use || true to continue if version already exists
          if [[ "$VERSION" == *"-"* ]]; then
            npm publish --access public --provenance --tag next || true
          else
            npm publish --access public --provenance || true
          fi

  # Update AUR packages
  update-aur:
    name: Update AUR packages
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          echo "Host aur.archlinux.org" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/aur" >> ~/.ssh/config
          echo "  User aur" >> ~/.ssh/config
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
      - name: Get checksums
        id: checksums
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "pkgver=${VERSION//-/_}" >> $GITHUB_OUTPUT

          SHA_X86=$(curl -sL "https://github.com/rustledger/rustledger/releases/download/v${VERSION}/rustledger-v${VERSION}-x86_64-unknown-linux-gnu.tar.gz" | sha256sum | cut -d' ' -f1)
          SHA_ARM=$(curl -sL "https://github.com/rustledger/rustledger/releases/download/v${VERSION}/rustledger-v${VERSION}-aarch64-unknown-linux-gnu.tar.gz" | sha256sum | cut -d' ' -f1)
          SHA_SRC=$(curl -sL "https://github.com/rustledger/rustledger/archive/refs/tags/v${VERSION}.tar.gz" | sha256sum | cut -d' ' -f1)

          echo "sha_x86=$SHA_X86" >> $GITHUB_OUTPUT
          echo "sha_arm=$SHA_ARM" >> $GITHUB_OUTPUT
          echo "sha_src=$SHA_SRC" >> $GITHUB_OUTPUT
      - name: Update rustledger-bin
        run: |
          git clone ssh://aur@aur.archlinux.org/rustledger-bin.git /tmp/aur-bin
          cd /tmp/aur-bin

          # Update PKGBUILD
          cp $GITHUB_WORKSPACE/packaging/aur/rustledger-bin/PKGBUILD .
          sed -i "s/^pkgver=.*/pkgver=${{ steps.checksums.outputs.pkgver }}/" PKGBUILD
          sed -i "s/^sha256sums_x86_64=.*/sha256sums_x86_64=('${{ steps.checksums.outputs.sha_x86 }}')/" PKGBUILD
          sed -i "s/^sha256sums_aarch64=.*/sha256sums_aarch64=('${{ steps.checksums.outputs.sha_arm }}')/" PKGBUILD

          # Generate .SRCINFO using Docker
          docker run --rm -v "$PWD:/pkg" archlinux:latest sh -c \
            "useradd -m builder && chown -R builder:builder /pkg && su builder -c 'cd /pkg && makepkg --printsrcinfo'" > .SRCINFO

          # Commit and push (exit 0 if nothing to commit - skips push)
          git config user.name "rustledger-ci"
          git config user.email "rustledger-ci@users.noreply.github.com"
          git add PKGBUILD .SRCINFO
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "Update to ${{ steps.checksums.outputs.version }}"
          git push
      - name: Update rustledger
        run: |
          git clone ssh://aur@aur.archlinux.org/rustledger.git /tmp/aur-src
          cd /tmp/aur-src

          # Update PKGBUILD
          cp $GITHUB_WORKSPACE/packaging/aur/rustledger/PKGBUILD .
          sed -i "s/^pkgver=.*/pkgver=${{ steps.checksums.outputs.pkgver }}/" PKGBUILD
          sed -i "s/^sha256sums=.*/sha256sums=('${{ steps.checksums.outputs.sha_src }}')/" PKGBUILD

          # Generate .SRCINFO using Docker
          docker run --rm -v "$PWD:/pkg" archlinux:latest sh -c \
            "useradd -m builder && chown -R builder:builder /pkg && su builder -c 'cd /pkg && makepkg --printsrcinfo'" > .SRCINFO

          # Commit and push (exit 0 if nothing to commit - skips push)
          git config user.name "rustledger-ci"
          git config user.email "rustledger-ci@users.noreply.github.com"
          git add PKGBUILD .SRCINFO
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "Update to ${{ steps.checksums.outputs.version }}"
          git push

  # Update nixpkgs (stable releases only)
  update-nixpkgs:
    name: Update nixpkgs
    needs: release
    runs-on: ubuntu-latest
    # Only run for stable releases (no hyphen in version)
    if: ${{ !contains(github.ref_name, '-') }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v30
      - name: Get hashes
        id: hashes
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Get source hash
          SRC_HASH=$(nix-prefetch-github rustledger rustledger --rev "v${VERSION}" --json | jq -r .hash)
          echo "src_hash=$SRC_HASH" >> $GITHUB_OUTPUT

          # Get cargo hash by building with fake hash and extracting from error
          cat > /tmp/package.nix << 'PKGEOF'
          { lib, rustPlatform, fetchFromGitHub }:
          rustPlatform.buildRustPackage rec {
            pname = "rustledger";
            version = "VERSION_PLACEHOLDER";
            src = fetchFromGitHub {
              owner = "rustledger";
              repo = "rustledger";
              rev = "v${version}";
              hash = "SRC_HASH_PLACEHOLDER";
            };
            cargoHash = "sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=";
            meta.license = lib.licenses.gpl3Only;
          }
          PKGEOF
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/" /tmp/package.nix
          sed -i "s|SRC_HASH_PLACEHOLDER|${SRC_HASH}|" /tmp/package.nix

          CARGO_HASH=$(nix-build -E 'with import <nixpkgs> {}; callPackage /tmp/package.nix {}' 2>&1 | grep "got:" | awk '{print $2}') || true
          echo "cargo_hash=$CARGO_HASH" >> $GITHUB_OUTPUT
      - name: Create nixpkgs PR
        env:
          GH_TOKEN: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
        run: |
          VERSION=${{ steps.hashes.outputs.version }}
          SRC_HASH=${{ steps.hashes.outputs.src_hash }}
          CARGO_HASH=${{ steps.hashes.outputs.cargo_hash }}

          # Fork and clone nixpkgs
          gh repo fork NixOS/nixpkgs --clone --remote
          cd nixpkgs

          # Check if package already exists and get current version
          OLD_VERSION=""
          if [ -f pkgs/by-name/ru/rustledger/package.nix ]; then
            OLD_VERSION=$(grep 'version = "' pkgs/by-name/ru/rustledger/package.nix | head -1 | sed 's/.*version = "\([^"]*\)".*/\1/')
          fi

          # Create branch
          git checkout -b "rustledger-${VERSION}"

          # Create package directory
          mkdir -p pkgs/by-name/ru/rustledger

          # Write package.nix
          cat > pkgs/by-name/ru/rustledger/package.nix << PKGEOF
          {
            lib,
            rustPlatform,
            fetchFromGitHub,
          }:

          rustPlatform.buildRustPackage rec {
            pname = "rustledger";
            version = "${VERSION}";

            src = fetchFromGitHub {
              owner = "rustledger";
              repo = "rustledger";
              rev = "v\${version}";
              hash = "${SRC_HASH}";
            };

            cargoHash = "${CARGO_HASH}";

            meta = with lib; {
              description = "Fast, pure Rust implementation of Beancount double-entry accounting";
              homepage = "https://rustledger.github.io";
              changelog = "https://github.com/rustledger/rustledger/releases/tag/v\${version}";
              license = licenses.gpl3Only;
              maintainers = with maintainers; [ ];
              mainProgram = "rledger-check";
            };
          }
          PKGEOF

          # Determine PR title and body based on whether this is init or update
          if [ -n "$OLD_VERSION" ]; then
            PR_TITLE="rustledger: ${OLD_VERSION} -> ${VERSION}"
            PR_BODY="## Description

          Update [rustledger](https://github.com/rustledger/rustledger) from ${OLD_VERSION} to ${VERSION}.

          [Changelog](https://github.com/rustledger/rustledger/releases/tag/v${VERSION})

          ---
          *Automated PR from rustledger release workflow*"
            COMMIT_MSG="rustledger: ${OLD_VERSION} -> ${VERSION}"
          else
            PR_TITLE="rustledger: init at ${VERSION}"
            PR_BODY="## Description

          Add [rustledger](https://github.com/rustledger/rustledger), a fast pure Rust implementation of Beancount double-entry accounting.

          - 10x faster than Python beancount
          - Full Beancount syntax compatibility
          - Single binary, no Python dependencies

          ## Things done

          - Built on x86_64-linux
          - Tested basic functionality

          ---
          *Automated PR from rustledger release workflow*"
            COMMIT_MSG="rustledger: init at ${VERSION}"
          fi

          # Commit and push
          git config user.name "rustledger-ci"
          git config user.email "rustledger-ci@users.noreply.github.com"
          git add pkgs/by-name/ru/rustledger/package.nix
          git commit -m "$COMMIT_MSG"
          git push -u origin "rustledger-${VERSION}"

          # Create PR
          gh pr create \
            --repo NixOS/nixpkgs \
            --title "$PR_TITLE" \
            --body "$PR_BODY"

  # Trigger COPR build (Fedora/RHEL)
  # COPR is configured to build from SCM (GitHub) with spec file at packaging/rpm/rustledger.spec
  # This job triggers a rebuild when a new release is tagged
  update-copr:
    name: Trigger COPR build
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Install copr-cli
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install copr-cli
      - name: Configure COPR
        run: |
          mkdir -p ~/.config
          cat > ~/.config/copr << EOF
          [copr-cli]
          login = rustledger
          username = rustledger
          token = ${{ secrets.COPR_API_TOKEN }}
          copr_url = https://copr.fedorainfracloud.org
          EOF
      - name: Trigger SCM build
        run: |
          # Trigger a build using COPR's SCM integration
          # The project is configured to fetch from GitHub and use packaging/rpm/rustledger.spec
          copr-cli build-package rustledger/rustledger \
            --name rustledger \
            --nowait || true

  # Upload to Launchpad PPA (Ubuntu/Debian)
  update-ppa:
    name: Upload to PPA
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper dput gnupg rustc cargo
      - name: Setup GPG key
        run: |
          echo "${{ secrets.LAUNCHPAD_GPG_PRIVATE_KEY }}" | gpg --batch --import
          # Get key ID and set trust
          KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -1 | awk '{print $2}' | cut -d'/' -f2)
          echo "${KEY_ID}:6:" | gpg --import-ownertrust
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LAUNCHPAD_SSH_PRIVATE_KEY }}" > ~/.ssh/launchpad
          chmod 600 ~/.ssh/launchpad
          cat >> ~/.ssh/config << EOF
          Host ppa.launchpad.net
            IdentityFile ~/.ssh/launchpad
            User rustledger
          EOF
          ssh-keyscan ppa.launchpad.net >> ~/.ssh/known_hosts
      - name: Configure dput
        run: |
          cat > ~/.dput.cf << EOF
          [rustledger-ppa]
          fqdn = ppa.launchpad.net
          method = sftp
          incoming = ~rustledger/ubuntu/rustledger/
          login = rustledger
          allow_unsigned_uploads = 0
          EOF
      - name: Build and upload source package
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          # Convert version: 1.0.0-rc.18 -> 1.0.0~rc.18 for Debian
          DEB_VERSION=$(echo "$VERSION" | sed 's/-/~/g')

          # Create source tarball
          TARBALL="rustledger_${DEB_VERSION}.orig.tar.gz"
          git archive --format=tar.gz --prefix="rustledger-${DEB_VERSION}/" HEAD > "../${TARBALL}"

          # Extract and prepare
          cd ..
          tar -xzf "${TARBALL}"
          cd "rustledger-${DEB_VERSION}"

          # Copy debian directory
          cp -r $GITHUB_WORKSPACE/packaging/debian .

          # Update changelog for each Ubuntu series
          for SERIES in noble jammy focal; do
            # Update changelog
            CHANGES="rustledger (${DEB_VERSION}-1~${SERIES}1) ${SERIES}; urgency=medium

  * Update to version ${VERSION}

 -- rustledger <rustledger@users.noreply.github.com>  $(date -R)

"
            echo -e "${CHANGES}\n$(cat debian/changelog)" > debian/changelog

            # Build source package
            debuild -S -sa -k"$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -1 | awk '{print $2}' | cut -d'/' -f2)"

            # Upload to PPA
            dput rustledger-ppa "../rustledger_${DEB_VERSION}-1~${SERIES}1_source.changes" || true

            # Restore original changelog for next series
            git checkout debian/changelog
          done
