# Release workflow - builds binaries for all platforms
name: Release
on:
  push:
    tags:
      - 'v*'
permissions:
  contents: write
  id-token: write # Required for npm trusted publishing (OIDC)
  packages: write # Required for GitHub Container Registry
env:
  CARGO_TERM_COLOR: always
jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux (glibc)
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true
          # Linux (musl - static binaries)
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            cross: true
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            cross: true
          # macOS
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest
          # Windows
          - target: x86_64-pc-windows-msvc
            os: windows-latest
          - target: aarch64-pc-windows-msvc
            os: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Install cross
        if: matrix.cross
        uses: taiki-e/install-action@cross
      - name: Build
        shell: bash
        run: |
          # Use classic linker on macOS - Xcode 15's new linker crashes on long symbol names
          # See: https://developer.apple.com/forums/thread/737707
          if [ "${{ runner.os }}" = "macOS" ]; then
            export RUSTFLAGS="-C link-arg=-Wl,-ld_classic"
          fi

          if [ "${{ matrix.cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
      - name: Package (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd target/${{ matrix.target }}/release

          # Get version from tag
          VERSION=${GITHUB_REF#refs/tags/}

          # Create archive with all binaries
          ARCHIVE="rustledger-${VERSION}-${{ matrix.target }}.tar.gz"
          tar -czvf "../../../${ARCHIVE}" \
            rledger-check rledger-format rledger-query rledger-report rledger-doctor rledger-extract rledger-price \
            bean-check bean-format bean-query bean-report bean-doctor bean-extract bean-price

          # Create checksum
          cd ../../..
          shasum -a 256 "$ARCHIVE" > "${ARCHIVE}.sha256"
      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd target/${{ matrix.target }}/release

          # Get version from tag
          $VERSION = $env:GITHUB_REF -replace 'refs/tags/', ''

          # Create archive with all binaries
          $ARCHIVE = "rustledger-${VERSION}-${{ matrix.target }}.zip"
          $binaries = @(
            "rledger-check.exe", "rledger-format.exe", "rledger-query.exe", "rledger-report.exe", "rledger-doctor.exe", "rledger-extract.exe", "rledger-price.exe",
            "bean-check.exe", "bean-format.exe", "bean-query.exe", "bean-report.exe", "bean-doctor.exe", "bean-extract.exe", "bean-price.exe"
          )
          Compress-Archive -Path $binaries -DestinationPath "../../../${ARCHIVE}"

          # Create checksum
          cd ../../..
          (Get-FileHash -Algorithm SHA256 $ARCHIVE).Hash.ToLower() + "  " + $ARCHIVE | Out-File -Encoding utf8 "${ARCHIVE}.sha256"
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rustledger-${{ matrix.target }}
          path: |
            rustledger-*.tar.gz
            rustledger-*.zip
            rustledger-*.sha256
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      - name: List artifacts
        run: ls -la artifacts/
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          generate_release_notes: true
          files: |
            artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # Update Homebrew tap
  update-homebrew:
    name: Update Homebrew formula
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Homebrew tap update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
          repository: rustledger/homebrew-rustledger
          event-type: release
          client-payload: '{"version": "${{ github.ref_name }}"}'
  # Publish to crates.io
  publish:
    name: Publish to crates.io
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Publish crates (in dependency order)
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          # Publish in dependency order with delay between each
          # to allow crates.io to index the previous crate
          # Use || true to continue if crate already exists

          echo "Publishing rustledger-core..."
          cargo publish -p rustledger-core --no-verify || true
          sleep 30

          echo "Publishing rustledger-parser..."
          cargo publish -p rustledger-parser --no-verify || true
          sleep 30

          echo "Publishing rustledger-booking..."
          cargo publish -p rustledger-booking --no-verify || true
          sleep 30

          echo "Publishing rustledger-loader..."
          cargo publish -p rustledger-loader --no-verify || true
          sleep 30

          echo "Publishing rustledger-validate..."
          cargo publish -p rustledger-validate --no-verify || true
          sleep 30

          echo "Publishing rustledger-query..."
          cargo publish -p rustledger-query --no-verify || true
          sleep 30

          echo "Publishing rustledger-plugin..."
          cargo publish -p rustledger-plugin --no-verify || true
          sleep 30

          echo "Publishing rustledger (CLI)..."
          cargo publish -p rustledger --no-verify || true

          echo "All crates published!"
  # Build and upload WASM to GitHub release
  upload-wasm:
    name: Upload WASM to Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      - name: Build WASM package
        run: |
          cd crates/rustledger-wasm
          wasm-pack build --target web --release
      - name: Package WASM
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          cd crates/rustledger-wasm/pkg
          # Update package.json version
          sed -i "s/\"version\": \".*\"/\"version\": \"${VERSION#v}\"/" package.json
          sed -i 's/"name": "rustledger-wasm"/"name": "@rustledger\/wasm"/' package.json
          # Create archive
          tar -czvf "../../../rustledger-wasm-${VERSION}.tar.gz" .
          cd ../../..
          shasum -a 256 "rustledger-wasm-${VERSION}.tar.gz" > "rustledger-wasm-${VERSION}.tar.gz.sha256"
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            rustledger-wasm-*.tar.gz
            rustledger-wasm-*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # Publish WASM package to npm
  publish-wasm:
    name: Publish to npm
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
      - name: Update npm for OIDC support
        run: npm install -g npm@latest
      - name: Build WASM package
        run: |
          cd crates/rustledger-wasm
          wasm-pack build --target web --release
      - name: Update package.json version
        run: |
          cd crates/rustledger-wasm/pkg
          VERSION=${GITHUB_REF#refs/tags/v}
          # Update version in package.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json
          # Update package name if needed
          sed -i 's/"name": "rustledger-wasm"/"name": "@rustledger\/wasm"/' package.json
      - name: Publish to npm (trusted publishing)
        run: |
          cd crates/rustledger-wasm/pkg
          VERSION=${GITHUB_REF#refs/tags/v}
          # Use --tag next for prereleases, --tag latest for stable
          # Use || true to continue if version already exists
          if [[ "$VERSION" == *"-"* ]]; then
            npm publish --access public --provenance --tag next || true
          else
            npm publish --access public --provenance || true
          fi
  # Trigger website rebuild to use new WASM package
  trigger-website:
    name: Trigger website rebuild
    needs: publish-wasm
    runs-on: ubuntu-latest
    steps:
      - name: Trigger website rebuild
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
          repository: rustledger/rustledger.github.io
          event-type: wasm-release

  # Build and push Docker images
  docker:
    name: Build Docker images
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download musl artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: rustledger-*-linux-musl
          merge-multiple: true
      - name: Extract binaries
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          mkdir -p docker-context/amd64 docker-context/arm64
          tar -xzf "artifacts/rustledger-${VERSION}-x86_64-unknown-linux-musl.tar.gz" -C docker-context/amd64
          tar -xzf "artifacts/rustledger-${VERSION}-aarch64-unknown-linux-musl.tar.gz" -C docker-context/arm64
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Generate Dockerfile
        run: |
          cat > docker-context/Dockerfile << 'EOF'
          FROM scratch
          ARG TARGETARCH
          COPY ${TARGETARCH}/* /usr/local/bin/
          ENTRYPOINT ["rledger-check"]
          EOF
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/rustledger/rustledger
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable=${{ !contains(github.ref, '-') }}
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: docker-context
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Publish MCP server to npm
  publish-mcp:
    name: Publish MCP server to npm
    needs: publish-wasm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
      - name: Update npm for OIDC support
        run: npm install -g npm@latest
      - name: Wait for npm registry propagation
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Waiting for @rustledger/wasm@$VERSION to be available on npm..."
          for i in {1..12}; do
            if npm view @rustledger/wasm@$VERSION version 2>/dev/null; then
              echo "Package available!"
              exit 0
            fi
            echo "Attempt $i: Package not yet available, waiting 30s..."
            sleep 30
          done
          echo "Package not available after 6 minutes"
          exit 1
      - name: Update version and install dependencies
        run: |
          cd packages/mcp-server
          VERSION=${GITHUB_REF#refs/tags/v}
          # Update version in package.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json
          # Update @rustledger/wasm dependency to use npm package
          sed -i 's|"@rustledger/wasm": "file:../../crates/rustledger-wasm/pkg"|"@rustledger/wasm": "^'$VERSION'"|' package.json
          npm install
      - name: Build
        run: |
          cd packages/mcp-server
          npm run build
      - name: Publish to npm (trusted publishing)
        run: |
          cd packages/mcp-server
          VERSION=${GITHUB_REF#refs/tags/v}
          # Use --tag next for prereleases, --tag latest for stable
          # Use || true to continue if version already exists
          if [[ "$VERSION" == *"-"* ]]; then
            npm publish --access public --provenance --tag next || true
          else
            npm publish --access public --provenance || true
          fi

  # Update AUR packages
  update-aur:
    name: Update AUR packages
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          echo "Host aur.archlinux.org" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/aur" >> ~/.ssh/config
          echo "  User aur" >> ~/.ssh/config
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
      - name: Get checksums
        id: checksums
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "pkgver=${VERSION//-/_}" >> $GITHUB_OUTPUT

          SHA_X86=$(curl -sL "https://github.com/rustledger/rustledger/releases/download/v${VERSION}/rustledger-v${VERSION}-x86_64-unknown-linux-gnu.tar.gz" | sha256sum | cut -d' ' -f1)
          SHA_ARM=$(curl -sL "https://github.com/rustledger/rustledger/releases/download/v${VERSION}/rustledger-v${VERSION}-aarch64-unknown-linux-gnu.tar.gz" | sha256sum | cut -d' ' -f1)
          SHA_SRC=$(curl -sL "https://github.com/rustledger/rustledger/archive/refs/tags/v${VERSION}.tar.gz" | sha256sum | cut -d' ' -f1)

          echo "sha_x86=$SHA_X86" >> $GITHUB_OUTPUT
          echo "sha_arm=$SHA_ARM" >> $GITHUB_OUTPUT
          echo "sha_src=$SHA_SRC" >> $GITHUB_OUTPUT
      - name: Update rustledger-bin
        run: |
          git clone ssh://aur@aur.archlinux.org/rustledger-bin.git /tmp/aur-bin
          cd /tmp/aur-bin

          # Update PKGBUILD
          cp $GITHUB_WORKSPACE/packaging/aur/rustledger-bin/PKGBUILD .
          sed -i "s/^pkgver=.*/pkgver=${{ steps.checksums.outputs.pkgver }}/" PKGBUILD
          sed -i "s/^sha256sums_x86_64=.*/sha256sums_x86_64=('${{ steps.checksums.outputs.sha_x86 }}')/" PKGBUILD
          sed -i "s/^sha256sums_aarch64=.*/sha256sums_aarch64=('${{ steps.checksums.outputs.sha_arm }}')/" PKGBUILD

          # Generate .SRCINFO using Docker
          docker run --rm -v "$PWD:/pkg" archlinux:latest sh -c \
            "useradd -m builder && chown -R builder:builder /pkg && su builder -c 'cd /pkg && makepkg --printsrcinfo'" > .SRCINFO

          # Commit and push
          git config user.name "rustledger-ci"
          git config user.email "rustledger-ci@users.noreply.github.com"
          git add PKGBUILD .SRCINFO
          git commit -m "Update to ${{ steps.checksums.outputs.version }}" || exit 0
          git push
      - name: Update rustledger
        run: |
          git clone ssh://aur@aur.archlinux.org/rustledger.git /tmp/aur-src
          cd /tmp/aur-src

          # Update PKGBUILD
          cp $GITHUB_WORKSPACE/packaging/aur/rustledger/PKGBUILD .
          sed -i "s/^pkgver=.*/pkgver=${{ steps.checksums.outputs.pkgver }}/" PKGBUILD
          sed -i "s/^sha256sums=.*/sha256sums=('${{ steps.checksums.outputs.sha_src }}')/" PKGBUILD

          # Generate .SRCINFO using Docker
          docker run --rm -v "$PWD:/pkg" archlinux:latest sh -c \
            "useradd -m builder && chown -R builder:builder /pkg && su builder -c 'cd /pkg && makepkg --printsrcinfo'" > .SRCINFO

          # Commit and push
          git config user.name "rustledger-ci"
          git config user.email "rustledger-ci@users.noreply.github.com"
          git add PKGBUILD .SRCINFO
          git commit -m "Update to ${{ steps.checksums.outputs.version }}" || exit 0
          git push
