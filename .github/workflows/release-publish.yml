# Release Publish Workflow
# ========================
# Triggered when a GitHub Release is published, or manually via workflow_dispatch.
# Distributes the release to all package managers and registries.
#
# This workflow is separate from release-build.yml so that if distribution fails,
# you can re-run just this workflow without rebuilding all binaries.
#
# DISTRIBUTION CHANNELS
# ---------------------
# | Channel      | Repo/Registry                          |
# |--------------|----------------------------------------|
# | npm (wasm)   | @rustledger/wasm                       |
# | npm (mcp)    | @rustledger/mcp-server                 |
# | Docker       | ghcr.io/rustledger/rustledger          |
# | Homebrew     | rustledger/homebrew-rustledger         |
# | Scoop        | rustledger/scoop-rustledger            |
# | COPR         | copr.fedorainfracloud.org/rustledger   |
#
# SECRETS REQUIRED
# ----------------
# - WEBSITE_DISPATCH_TOKEN: Homebrew/Scoop automation
# - COPR_LOGIN / COPR_TOKEN: COPR build trigger
# - (npm uses OIDC trusted publishing, no token needed)
#
name: Release Publish
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to publish (e.g., v0.1.0)'
        required: true
        type: string
permissions:
  contents: read
  id-token: write # Required for npm trusted publishing (OIDC)
  packages: write # Required for GitHub Container Registry
env:
  CARGO_TERM_COLOR: always
  # Use input tag for workflow_dispatch, otherwise use the release tag
  RELEASE_TAG: ${{ inputs.tag || github.event.release.tag_name }}
jobs:
  # Publish WASM package to npm
  publish-npm-wasm:
    name: Publish to npm (@rustledger/wasm)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      - name: Build WASM package
        run: |
          cd crates/rustledger-wasm
          wasm-pack build --target web --release
      - name: Prepare package
        run: |
          VERSION=${RELEASE_TAG#v}
          cd crates/rustledger-wasm/pkg
          sed -i "s/\"version\": \".*\"/\"version\": \"${VERSION}\"/" package.json
          sed -i 's/"name": "rustledger-wasm"/"name": "@rustledger\/wasm"/' package.json
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
      - name: Update npm for OIDC support
        run: npm install -g npm@latest
      - name: Publish to npm (trusted publishing)
        run: |
          cd crates/rustledger-wasm/pkg
          npm publish --access public --provenance || true

  # Trigger website rebuild to use new WASM package
  trigger-website:
    name: Trigger website rebuild
    needs: publish-npm-wasm
    runs-on: ubuntu-latest
    steps:
      - name: Trigger website rebuild
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
          repository: rustledger/rustledger.github.io
          event-type: wasm-release

  # Publish MCP server to npm
  publish-npm-mcp:
    name: Publish MCP server to npm
    needs: publish-npm-wasm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
      - name: Update npm for OIDC support
        run: npm install -g npm@latest
      - name: Wait for npm registry propagation
        run: |
          VERSION=${RELEASE_TAG#v}
          echo "Waiting for @rustledger/wasm@$VERSION to be available on npm..."
          for i in {1..12}; do
            if npm view @rustledger/wasm@$VERSION version 2>/dev/null; then
              echo "Package available!"
              exit 0
            fi
            echo "Attempt $i: Package not yet available, waiting 30s..."
            sleep 30
          done
          echo "Package not available after 6 minutes"
          exit 1
      - name: Update version and install dependencies
        run: |
          cd packages/mcp-server
          VERSION=${RELEASE_TAG#v}
          # Update version in package.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json
          # Update @rustledger/wasm dependency to use npm package
          sed -i 's|"@rustledger/wasm": "file:../../crates/rustledger-wasm/pkg"|"@rustledger/wasm": "^'$VERSION'"|' package.json
          npm install
      - name: Build
        run: |
          cd packages/mcp-server
          npm run build
      - name: Publish to npm (trusted publishing)
        run: |
          cd packages/mcp-server
          npm publish --access public --provenance || true

  # Build and push Docker images
  publish-docker:
    name: Build Docker images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}
      - name: Download musl binaries from release
        run: |
          VERSION=$RELEASE_TAG
          mkdir -p artifacts
          # Download musl binaries from GitHub Release
          curl -sL "https://github.com/rustledger/rustledger/releases/download/${VERSION}/rustledger-${VERSION}-x86_64-unknown-linux-musl.tar.gz" -o "artifacts/rustledger-${VERSION}-x86_64-unknown-linux-musl.tar.gz"
          curl -sL "https://github.com/rustledger/rustledger/releases/download/${VERSION}/rustledger-${VERSION}-aarch64-unknown-linux-musl.tar.gz" -o "artifacts/rustledger-${VERSION}-aarch64-unknown-linux-musl.tar.gz"
      - name: Extract binaries
        run: |
          VERSION=$RELEASE_TAG
          mkdir -p docker-context/amd64 docker-context/arm64
          tar -xzf "artifacts/rustledger-${VERSION}-x86_64-unknown-linux-musl.tar.gz" -C docker-context/amd64
          tar -xzf "artifacts/rustledger-${VERSION}-aarch64-unknown-linux-musl.tar.gz" -C docker-context/arm64
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Generate Dockerfile
        run: |
          cat > docker-context/Dockerfile << 'EOF'
          FROM scratch
          ARG TARGETARCH
          COPY ${TARGETARCH}/* /usr/local/bin/
          ENTRYPOINT ["rledger-check"]
          EOF
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/rustledger/rustledger
          tags: |
            type=semver,pattern={{version}},value=${{ env.RELEASE_TAG != '' && env.RELEASE_TAG || github.ref_name }}
            type=semver,pattern={{major}}.{{minor}},value=${{ env.RELEASE_TAG != '' && env.RELEASE_TAG || github.ref_name }}
            type=raw,value=latest
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: docker-context
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Update Homebrew tap
  update-homebrew:
    name: Update Homebrew formula
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Homebrew tap update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
          repository: rustledger/homebrew-rustledger
          event-type: release
          client-payload: '{"version": "${{ env.RELEASE_TAG }}"}'

  # Update Scoop bucket
  update-scoop:
    name: Update Scoop bucket
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Scoop bucket update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
          repository: rustledger/scoop-rustledger
          event-type: release
          client-payload: '{"version": "${{ env.RELEASE_TAG }}"}'

  # Trigger COPR build (Fedora/RHEL)
  update-copr:
    name: Trigger COPR build
    runs-on: ubuntu-latest
    steps:
      - name: Install copr-cli
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install copr-cli
      - name: Configure COPR
        run: |
          mkdir -p ~/.config
          cat > ~/.config/copr << 'EOF'
          [copr-cli]
          login = ${{ secrets.COPR_LOGIN }}
          username = robcohen
          token = ${{ secrets.COPR_TOKEN }}
          copr_url = https://copr.fedorainfracloud.org
          EOF
      - name: Trigger SCM build
        run: |
          # Trigger a build using COPR's SCM integration
          # The project is configured to fetch from GitHub and use packaging/rpm/rustledger.spec
          copr-cli build-package robcohen/rustledger \
            --name rustledger \
            --nowait || true

