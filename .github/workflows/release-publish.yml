# Release Publish Workflow
# ========================
# Triggered when a GitHub Release is published, or manually via workflow_dispatch.
# Distributes the release to all package managers and registries.
#
# This workflow is separate from release-build.yml so that if distribution fails,
# you can re-run just this workflow without rebuilding all binaries.
#
# DISTRIBUTION CHANNELS
# ---------------------
# | Channel      | Repo/Registry                          |
# |--------------|----------------------------------------|
# | npm (wasm)   | @rustledger/wasm                       |
# | npm (mcp)    | @rustledger/mcp-server                 |
# | Docker       | ghcr.io/rustledger/rustledger          |
# | Homebrew     | rustledger/homebrew-rustledger         |
# | Scoop        | rustledger/scoop-rustledger            |
# | AUR          | aur.archlinux.org/rustledger{,-bin}    |
# | COPR         | copr.fedorainfracloud.org/rustledger   |
# | PPA          | ppa:rustledger/rustledger              |
#
# SECRETS REQUIRED
# ----------------
# - WEBSITE_DISPATCH_TOKEN: Homebrew/Scoop automation
# - AUR_SSH_PRIVATE_KEY: AUR push access
# - COPR_LOGIN / COPR_TOKEN: COPR build trigger
# - LAUNCHPAD_SSH_PRIVATE_KEY: Launchpad upload access
# - LAUNCHPAD_GPG_PRIVATE_KEY: PPA package signing
# - (npm uses OIDC trusted publishing, no token needed)
#
name: Release Publish
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to publish (e.g., v0.1.0)'
        required: true
        type: string
permissions:
  contents: read
  id-token: write # Required for npm trusted publishing (OIDC)
  packages: write # Required for GitHub Container Registry
env:
  CARGO_TERM_COLOR: always
  # Use input tag for workflow_dispatch, otherwise use the release tag
  RELEASE_TAG: ${{ inputs.tag || github.event.release.tag_name }}
jobs:
  # Publish WASM package to npm
  publish-npm-wasm:
    name: Publish to npm (@rustledger/wasm)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      - name: Build WASM package
        run: |
          cd crates/rustledger-wasm
          wasm-pack build --target web --release
      - name: Prepare package
        run: |
          VERSION=${RELEASE_TAG#v}
          cd crates/rustledger-wasm/pkg
          sed -i "s/\"version\": \".*\"/\"version\": \"${VERSION}\"/" package.json
          sed -i 's/"name": "rustledger-wasm"/"name": "@rustledger\/wasm"/' package.json
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
      - name: Update npm for OIDC support
        run: npm install -g npm@latest
      - name: Publish to npm (trusted publishing)
        run: |
          cd crates/rustledger-wasm/pkg
          npm publish --access public --provenance || true

  # Trigger website rebuild to use new WASM package
  trigger-website:
    name: Trigger website rebuild
    needs: publish-npm-wasm
    runs-on: ubuntu-latest
    steps:
      - name: Trigger website rebuild
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
          repository: rustledger/rustledger.github.io
          event-type: wasm-release

  # Publish MCP server to npm
  publish-npm-mcp:
    name: Publish MCP server to npm
    needs: publish-npm-wasm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
      - name: Update npm for OIDC support
        run: npm install -g npm@latest
      - name: Wait for npm registry propagation
        run: |
          VERSION=${RELEASE_TAG#v}
          echo "Waiting for @rustledger/wasm@$VERSION to be available on npm..."
          for i in {1..12}; do
            if npm view @rustledger/wasm@$VERSION version 2>/dev/null; then
              echo "Package available!"
              exit 0
            fi
            echo "Attempt $i: Package not yet available, waiting 30s..."
            sleep 30
          done
          echo "Package not available after 6 minutes"
          exit 1
      - name: Update version and install dependencies
        run: |
          cd packages/mcp-server
          VERSION=${RELEASE_TAG#v}
          # Update version in package.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json
          # Update @rustledger/wasm dependency to use npm package
          sed -i 's|"@rustledger/wasm": "file:../../crates/rustledger-wasm/pkg"|"@rustledger/wasm": "^'$VERSION'"|' package.json
          npm install
      - name: Build
        run: |
          cd packages/mcp-server
          npm run build
      - name: Publish to npm (trusted publishing)
        run: |
          cd packages/mcp-server
          npm publish --access public --provenance || true

  # Build and push Docker images
  publish-docker:
    name: Build Docker images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}
      - name: Download musl binaries from release
        run: |
          VERSION=$RELEASE_TAG
          mkdir -p artifacts
          # Download musl binaries from GitHub Release
          curl -sL "https://github.com/rustledger/rustledger/releases/download/${VERSION}/rustledger-${VERSION}-x86_64-unknown-linux-musl.tar.gz" -o "artifacts/rustledger-${VERSION}-x86_64-unknown-linux-musl.tar.gz"
          curl -sL "https://github.com/rustledger/rustledger/releases/download/${VERSION}/rustledger-${VERSION}-aarch64-unknown-linux-musl.tar.gz" -o "artifacts/rustledger-${VERSION}-aarch64-unknown-linux-musl.tar.gz"
      - name: Extract binaries
        run: |
          VERSION=$RELEASE_TAG
          mkdir -p docker-context/amd64 docker-context/arm64
          tar -xzf "artifacts/rustledger-${VERSION}-x86_64-unknown-linux-musl.tar.gz" -C docker-context/amd64
          tar -xzf "artifacts/rustledger-${VERSION}-aarch64-unknown-linux-musl.tar.gz" -C docker-context/arm64
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Generate Dockerfile
        run: |
          cat > docker-context/Dockerfile << 'EOF'
          FROM scratch
          ARG TARGETARCH
          COPY ${TARGETARCH}/* /usr/local/bin/
          ENTRYPOINT ["rledger-check"]
          EOF
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/rustledger/rustledger
          tags: |
            type=semver,pattern={{version}},value=${{ env.RELEASE_TAG != '' && env.RELEASE_TAG || github.ref_name }}
            type=semver,pattern={{major}}.{{minor}},value=${{ env.RELEASE_TAG != '' && env.RELEASE_TAG || github.ref_name }}
            type=raw,value=latest
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: docker-context
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Update Homebrew tap
  update-homebrew:
    name: Update Homebrew formula
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Homebrew tap update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
          repository: rustledger/homebrew-rustledger
          event-type: release
          client-payload: '{"version": "${{ env.RELEASE_TAG }}"}'

  # Update Scoop bucket
  update-scoop:
    name: Update Scoop bucket
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Scoop bucket update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
          repository: rustledger/scoop-rustledger
          event-type: release
          client-payload: '{"version": "${{ env.RELEASE_TAG }}"}'

  # Update AUR packages
  update-aur:
    name: Update AUR packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          # Write key preserving newlines (use printf to handle multi-line secrets)
          printf '%s\n' "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          # Validate key format
          if ! ssh-keygen -y -f ~/.ssh/aur > /dev/null 2>&1; then
            echo "::error::AUR SSH key is invalid. Ensure it's in PEM format with proper newlines."
            exit 1
          fi
          echo "Host aur.archlinux.org" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/aur" >> ~/.ssh/config
          echo "  User aur" >> ~/.ssh/config
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
      - name: Get checksums
        id: checksums
        run: |
          VERSION=${RELEASE_TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "pkgver=${VERSION//-/_}" >> $GITHUB_OUTPUT

          SHA_X86=$(curl -sL "https://github.com/rustledger/rustledger/releases/download/v${VERSION}/rustledger-v${VERSION}-x86_64-unknown-linux-gnu.tar.gz" | sha256sum | cut -d' ' -f1)
          SHA_ARM=$(curl -sL "https://github.com/rustledger/rustledger/releases/download/v${VERSION}/rustledger-v${VERSION}-aarch64-unknown-linux-gnu.tar.gz" | sha256sum | cut -d' ' -f1)
          SHA_SRC=$(curl -sL "https://github.com/rustledger/rustledger/archive/refs/tags/v${VERSION}.tar.gz" | sha256sum | cut -d' ' -f1)

          echo "sha_x86=$SHA_X86" >> $GITHUB_OUTPUT
          echo "sha_arm=$SHA_ARM" >> $GITHUB_OUTPUT
          echo "sha_src=$SHA_SRC" >> $GITHUB_OUTPUT
      - name: Update rustledger-bin
        run: |
          git clone ssh://aur@aur.archlinux.org/rustledger-bin.git /tmp/aur-bin
          cd /tmp/aur-bin

          # Update PKGBUILD
          cp $GITHUB_WORKSPACE/packaging/aur/rustledger-bin/PKGBUILD .
          sed -i "s/^pkgver=.*/pkgver=${{ steps.checksums.outputs.pkgver }}/" PKGBUILD
          sed -i "s/^sha256sums_x86_64=.*/sha256sums_x86_64=('${{ steps.checksums.outputs.sha_x86 }}')/" PKGBUILD
          sed -i "s/^sha256sums_aarch64=.*/sha256sums_aarch64=('${{ steps.checksums.outputs.sha_arm }}')/" PKGBUILD

          # Generate .SRCINFO using Docker
          docker run --rm -v "$PWD:/pkg" archlinux:latest sh -c \
            "useradd -m builder && chown -R builder:builder /pkg && su builder -c 'cd /pkg && makepkg --printsrcinfo'" > .SRCINFO

          # Commit and push (exit 0 if nothing to commit - skips push)
          git config user.name "rustledger-ci"
          git config user.email "rustledger-ci@users.noreply.github.com"
          git add PKGBUILD .SRCINFO
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "Update to ${{ steps.checksums.outputs.version }}"
          git push
      - name: Update rustledger
        run: |
          git clone ssh://aur@aur.archlinux.org/rustledger.git /tmp/aur-src
          cd /tmp/aur-src

          # Update PKGBUILD
          cp $GITHUB_WORKSPACE/packaging/aur/rustledger/PKGBUILD .
          sed -i "s/^pkgver=.*/pkgver=${{ steps.checksums.outputs.pkgver }}/" PKGBUILD
          sed -i "s/^sha256sums=.*/sha256sums=('${{ steps.checksums.outputs.sha_src }}')/" PKGBUILD

          # Generate .SRCINFO using Docker
          docker run --rm -v "$PWD:/pkg" archlinux:latest sh -c \
            "useradd -m builder && chown -R builder:builder /pkg && su builder -c 'cd /pkg && makepkg --printsrcinfo'" > .SRCINFO

          # Commit and push (exit 0 if nothing to commit - skips push)
          git config user.name "rustledger-ci"
          git config user.email "rustledger-ci@users.noreply.github.com"
          git add PKGBUILD .SRCINFO
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "Update to ${{ steps.checksums.outputs.version }}"
          git push

  # Trigger COPR build (Fedora/RHEL)
  update-copr:
    name: Trigger COPR build
    runs-on: ubuntu-latest
    steps:
      - name: Install copr-cli
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install copr-cli
      - name: Configure COPR
        run: |
          mkdir -p ~/.config
          cat > ~/.config/copr << 'EOF'
          [copr-cli]
          login = ${{ secrets.COPR_LOGIN }}
          username = robcohen
          token = ${{ secrets.COPR_TOKEN }}
          copr_url = https://copr.fedorainfracloud.org
          EOF
      - name: Trigger SCM build
        run: |
          # Trigger a build using COPR's SCM integration
          # The project is configured to fetch from GitHub and use packaging/rpm/rustledger.spec
          copr-cli build-package robcohen/rustledger \
            --name rustledger \
            --nowait || true

  # Upload to Launchpad PPA (Ubuntu/Debian)
  update-ppa:
    name: Upload to PPA
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper dput gnupg rustc cargo
      - name: Setup GPG key
        run: |
          echo "${{ secrets.LAUNCHPAD_GPG_PRIVATE_KEY }}" | gpg --batch --import
          # Get key fingerprint and set trust (use --with-colons for stable parsing)
          FINGERPRINT=$(gpg --list-secret-keys --with-colons | grep -m1 '^fpr' | cut -d: -f10)
          echo "${FINGERPRINT}:6:" | gpg --import-ownertrust
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          # Write key preserving newlines
          printf '%s\n' "${{ secrets.LAUNCHPAD_SSH_PRIVATE_KEY }}" > ~/.ssh/launchpad
          chmod 600 ~/.ssh/launchpad
          # Validate key format
          if ! ssh-keygen -y -f ~/.ssh/launchpad > /dev/null 2>&1; then
            echo "::error::Launchpad SSH key is invalid. Ensure it's in PEM format with proper newlines."
            exit 1
          fi
          cat >> ~/.ssh/config << EOF
          Host ppa.launchpad.net
            IdentityFile ~/.ssh/launchpad
            User rustledger
          EOF
          ssh-keyscan ppa.launchpad.net >> ~/.ssh/known_hosts
      - name: Configure dput
        run: |
          cat > ~/.dput.cf << EOF
          [rustledger-ppa]
          fqdn = ppa.launchpad.net
          method = sftp
          incoming = ~rustledger/ubuntu/rustledger/
          login = rustledger
          allow_unsigned_uploads = 0
          EOF
      - name: Build and upload source package
        run: |
          VERSION=${RELEASE_TAG#v}
          # Convert version: 1.0.0-rc.18 -> 1.0.0~rc.18 for Debian
          DEB_VERSION=$(echo "$VERSION" | sed 's/-/~/g')

          # Create source tarball
          TARBALL="rustledger_${DEB_VERSION}.orig.tar.gz"
          git archive --format=tar.gz --prefix="rustledger-${DEB_VERSION}/" HEAD > "../${TARBALL}"

          # Extract and prepare
          cd ..
          tar -xzf "${TARBALL}"
          cd "rustledger-${DEB_VERSION}"

          # Copy debian directory
          cp -r $GITHUB_WORKSPACE/packaging/debian .

          # Update changelog for each Ubuntu series
          for SERIES in noble jammy focal; do
            # Update changelog using heredoc to avoid YAML issues
            cat > /tmp/changelog_entry << CHLOG
          rustledger (${DEB_VERSION}-1~${SERIES}1) ${SERIES}; urgency=medium

            * Update to version ${VERSION}

           -- rustledger <rustledger@users.noreply.github.com>  $(date -R)

          CHLOG
            cat /tmp/changelog_entry debian/changelog > /tmp/new_changelog
            mv /tmp/new_changelog debian/changelog

            # Build source package (use --with-colons for stable GPG output parsing)
            GPG_KEY=$(gpg --list-secret-keys --with-colons | grep -m1 '^fpr' | cut -d: -f10)
            debuild -S -sa -k"${GPG_KEY}"

            # Upload to PPA
            dput rustledger-ppa "../rustledger_${DEB_VERSION}-1~${SERIES}1_source.changes" || true

            # Restore original changelog for next series
            git checkout debian/changelog
          done
