# Release-plz Workflow
# ====================
# Automates releases using conventional commits:
# - Creates release PRs with changelog updates
# - Syncs npm package versions
# - Creates git tags and GitHub releases
#
# Flow:
# 1. On push to main: Creates/updates a release PR
# 2. On PR merge: Creates git tag and GitHub release
# 3. Tag triggers release-build.yml and release-publish.yml
#
name: Release-plz

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always

jobs:
  release-plz:
    name: Release-plz
    runs-on: ubuntu-latest
    concurrency:
      group: release-plz-${{ github.ref }}
      cancel-in-progress: false
    # Don't run in forks
    if: github.repository == 'rustledger/rustledger'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          # Use PAT for checkout so PR triggers CI workflows
          token: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Use PAT to create PR so it triggers CI workflows automatically
      # (GITHUB_TOKEN can't trigger other workflows)
      - name: Run release-plz
        id: release-plz
        uses: release-plz/action@v0.5
        with:
          command: release-pr
        env:
          GITHUB_TOKEN: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}

      # Enable auto-merge for release PRs (will merge when checks pass and approved)
      - name: Enable auto-merge for release PR
        if: steps.release-plz.outputs.pr_created == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_DATA: ${{ steps.release-plz.outputs.pr }}
        run: |
          PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number // empty' 2>/dev/null || echo "")
          if [ -n "$PR_NUMBER" ]; then
            echo "Enabling auto-merge for PR #$PR_NUMBER"
            gh pr merge "$PR_NUMBER" --auto --merge || echo "Auto-merge setup failed (may need approval, branch protection, or permissions)"
          else
            echo "Could not extract PR number from output"
          fi

      # Sync npm versions to the release PR branch (not main!)
      # This ensures the version sync is included when the PR merges
      - name: Sync npm package versions
        if: steps.release-plz.outputs.pr_created == 'true' || steps.release-plz.outputs.pr_updated == 'true'
        env:
          GH_TOKEN: ${{ secrets.WEBSITE_DISPATCH_TOKEN }}
          PR_DATA: ${{ steps.release-plz.outputs.pr }}
        run: |
          # Extract the PR branch name from release-plz output
          PR_BRANCH=$(echo "$PR_DATA" | jq -r '.head_branch // empty' 2>/dev/null || echo "")
          if [ -z "$PR_BRANCH" ]; then
            echo "::error::Could not extract PR branch from release-plz output"
            exit 1
          fi
          echo "Release PR branch: $PR_BRANCH"

          # Checkout the release PR branch
          git fetch origin "$PR_BRANCH"
          git checkout "$PR_BRANCH"

          # Get the version from the workspace Cargo.toml [workspace.package] section
          VERSION=$(grep -A5 '^\[workspace\.package\]' Cargo.toml | grep '^version' | head -1 | sed 's/version = "\(.*\)"/\1/')
          if [ -z "$VERSION" ]; then
            # Fallback to root package version
            VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          fi
          if [ -z "$VERSION" ]; then
            echo "::error::Could not extract version from Cargo.toml"
            exit 1
          fi
          echo "Syncing npm packages to version $VERSION"

          # Update MCP server package.json using jq for safer JSON manipulation
          if [ -f "packages/mcp-server/package.json" ]; then
            jq --arg ver "$VERSION" '.version = $ver | .dependencies["@rustledger/wasm"] = "^\($ver)"' \
              packages/mcp-server/package.json > packages/mcp-server/package.json.tmp
            mv packages/mcp-server/package.json.tmp packages/mcp-server/package.json
            echo "Updated packages/mcp-server/package.json to version $VERSION"
          fi

          # Check if there are changes to commit
          if git diff --quiet packages/; then
            echo "No npm package changes needed"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add packages/
            git commit -m "chore: sync npm package versions to $VERSION"
            git push origin "$PR_BRANCH"
            echo "npm package versions synced to PR branch"
          fi

  # Create release when PR is merged
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: release-plz
    # Only run if this is a merge of a release-plz PR
    if: |
      github.event_name == 'push' &&
      contains(github.event.head_commit.message, 'chore: release')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run release-plz release
        uses: release-plz/action@v0.5
        with:
          command: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
